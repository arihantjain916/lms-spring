<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Chat UI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <link rel="stylesheet" href="index.css">

    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

</head>

<body>

    <div>
        <div>
            <label for="username">Username</label>
            <input id="username" name="username" type="text" value="arihant@125">
        </div>
        <div>
            <label for="password">Password</label>
            <input id="password" name="password" type="text" value="aarihant">
        </div>
        <button onclick="login()">Login</button>
    </div>
    <!-- Messages -->
    <div class="chat-container" id="chat">
        <div class="message assistant">
            ðŸ‘‹ <strong>Welcome to the Doubt Clearing Platform</strong><br>
            <small>Your space to ask questions and get clear answers.</small>
            <button onclick="connect()">Click to connect to Live AI Agent</button>
            <button onclick="fetchChats()">Click to fetch Old Chats</button>
        </div>
    </div>

    <!-- Input -->
    <div class="input-container">
        <div class="input-box">
            <input id="input" type="text" placeholder="Send a message..." oninput="toggleSend()"
                onkeydown="if(event.key === 'Enter') sendMessage()" />

            <button class="send-btn" id="sendBtn" onclick="sendMessage()" disabled>
                <span class="material-icons">send</span>
            </button>
        </div>
    </div>

    <script>
        const input = document.getElementById("input");
        const chat = document.getElementById("chat");
        const sendBtn = document.getElementById("sendBtn");

        const host = "https://localhost:8080/api"
        // const host = "http://localhost:8598/api"

        // Authorization
        // Bearer eyJhbGciOiJIUzI1NiJ9.eyJpZCI6IjFhOGYzOTQzLWFjYzctNDJkYS1hMDA3LTgzMDY2YmQzOWM1MiIsInVzZXJBZ2VudCI6IlBvc3RtYW5SdW50aW1lLzcuNTEuMCIsImlwQWRkcmVzcyI6IjA6MDowOjA6MDowOjA6MSIsInN1YiI6InVzZXIiLCJpYXQiOjE3NjY0MDE0MTUsImV4cCI6MTc2NjQ4NzgxNX0.qpO4O0QMACwYbJZ3Mamyhv75_iYDqQNwF6ytrYxHjzA
        // const stompClient = new StompJs.Client({
        //     webSocketFactory: () => new SockJS('http://localhost:8080/api/ws')
        // });

        let token = "eyJhbGciOiJIUzI1NiJ9.eyJpZCI6IjFhOGYzOTQzLWFjYzctNDJkYS1hMDA3LTgzMDY2YmQzOWM1MiIsInVzZXJBZ2VudCI6Ik1vemlsbGEvNS4wIChXaW5kb3dzIE5UIDEwLjA7IFdpbjY0OyB4NjQpIEFwcGxlV2ViS2l0LzUzNy4zNiAoS0hUTUwsIGxpa2UgR2Vja28pIENocm9tZS8xNDMuMC4wLjAgU2FmYXJpLzUzNy4zNiBFZGcvMTQzLjAuMC4wIiwiaXBBZGRyZXNzIjoiMDowOjA6MDowOjA6MDoxIiwic3ViIjoidXNlciIsImlhdCI6MTc2NjQ2NTM2NywiZXhwIjoxNzY2NTUxNzY3fQ.GuLc2Cx4gesgeVA9iW5ySjjesJ0uqN7eEJfg2eoL-Kg";

        const stompClient = new StompJs.Client({
            webSocketFactory: () => new SockJS(`${host}/ws`),
        });

        stompClient.onConnect = (frame) => {
            // setConnected(true);
            console.log('Connected: ' + frame);
            stompClient.subscribe('/topic/chat/response', (greeting) => {
                showGreeting(JSON.parse(greeting.body));
            });
        };

        stompClient.onWebSocketError = (error) => {
            console.error('Error with websocket', error);
        };

        function toggleSend() {
            sendBtn.disabled = input.value.trim() === "";
        }

        // To connect to the server
        function connect(token) {
            stompClient.connectHeaders = {
                Authorization: `Bearer ${token}`
            };
            stompClient.activate();
            alert("Connected to Live AI Agent");
        }
        stompClient.debug = (e) => console.log("Debug: " + e);


        function disconnect() {
            stompClient.deactivate();
            alert("Disconnected from Live AI Agent");
        }

        function sendMessage() {
            const text = input.value.trim();
            if (!text) return;

            addMessage(text, "user", false);
            input.value = "";
            toggleSend();

            stompClient.publish({
                destination: "/app/chat",
                body: JSON.stringify({ 'message': text })
            });
        }

        function showGreeting(message) {
            const disMessage = message?.message
            addMessage(disMessage, "assistant", true);
        }

        function addMessage(text, role, animate = true) {
            const div = document.createElement("div");
            div.className = `message ${role}`;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;

            if (role === "assistant" && animate) {
                // 1ï¸âƒ£ Convert markdown â†’ plain text first
                const temp = document.createElement("div");
                temp.innerHTML = DOMPurify.sanitize(marked.parse(text));
                const plainText = temp.textContent || temp.innerText;

                let i = 0;
                const interval = setInterval(() => {
                    div.textContent += DOMPurify.sanitize(plainText.charAt(i++));
                    chat.scrollTop = chat.scrollHeight;

                    if (i >= plainText.length) {
                        clearInterval(interval);

                        // 2ï¸âƒ£ Replace typed text with final rendered HTML
                        div.innerHTML = DOMPurify.sanitize(marked.parse(text));
                    }
                }, 20);

            } else {
                div.innerHTML = DOMPurify.sanitize(marked.parse(text));
            }
        }

        async function fetchChats() {
            try {
                const res = await axios.get(`${host}/chat`, {
                    withCredentials: true,
                })

                const chats = res?.data?.data

                chats?.forEach(chatItem => {

                    if (chatItem.prompt) {
                        addMessage(chatItem.prompt, "user", false);
                    }

                    if (chatItem.response) {
                        addMessage(chatItem.response, "assistant", false);
                    }
                });
            }
            catch (e) {
                console.log("{e}", e)
            }
        }

        async function login() {
            // e.preventDefault()

            const payload = {
                username: document.getElementById("username").value,
                password: document.getElementById("password").value
            }
            const res = await axios.post(`${host}/auth/login`, payload, { withCredentials: true, })
            token = res?.data?.token

            await fetchChats()
            connect(token)
        }


    </script>

</body>

</html>